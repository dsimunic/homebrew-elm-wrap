name: Update elm-wrap formula

on:
  repository_dispatch:
    types: [elm-wrap-release]

jobs:
  update-formula:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4

      - name: Set version variables
        id: vars
        run: |
          TAG="${{ github.event.client_payload.version }}"
          if [ -z "$TAG" ]; then
            echo "Missing version in client_payload" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          {
            echo "tag=$TAG"
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"

      - name: Download release artifacts and compute checksums
        id: sha
        run: |
          TAG="${{ steps.vars.outputs.tag }}"

          ARM_URL="https://github.com/dsimunic/elm-wrap/releases/download/${TAG}/elm-wrap-macos-arm64"
          AMD_URL="https://github.com/dsimunic/elm-wrap/releases/download/${TAG}/elm-wrap-macos-amd64"
          SRC_URL="https://github.com/dsimunic/elm-wrap/archive/refs/tags/${TAG}.tar.gz"

          echo "Downloading $ARM_URL"
          if ! curl -L -f -o elm-wrap-macos-arm64 "$ARM_URL"; then
            echo "ERROR: Failed to download ARM64 binary from $ARM_URL" >&2
            exit 1
          fi

          echo "Downloading $AMD_URL"
          if ! curl -L -f -o elm-wrap-macos-amd64 "$AMD_URL"; then
            echo "ERROR: Failed to download AMD64 binary from $AMD_URL" >&2
            exit 1
          fi

          echo "Downloading $SRC_URL"
          if ! curl -L -f -o source.tar.gz "$SRC_URL"; then
            echo "ERROR: Failed to download source tarball from $SRC_URL" >&2
            exit 1
          fi

          ARM_SHA=$(shasum -a 256 elm-wrap-macos-arm64 | awk '{print $1}')
          AMD_SHA=$(shasum -a 256 elm-wrap-macos-amd64 | awk '{print $1}')
          SRC_SHA=$(shasum -a 256 source.tar.gz | awk '{print $1}')

          {
            echo "arm_sha=$ARM_SHA"
            echo "amd_sha=$AMD_SHA"
            echo "src_sha=$SRC_SHA"
          } >> "$GITHUB_OUTPUT"

      - name: Update elm-wrap formula
        run: |
          TAG="${{ steps.vars.outputs.tag }}"
          VERSION="${{ steps.vars.outputs.version }}"
          ARM_SHA="${{ steps.sha.outputs.arm_sha }}"
          AMD_SHA="${{ steps.sha.outputs.amd_sha }}"
          SRC_SHA="${{ steps.sha.outputs.src_sha }}"

          FORMULA="Formula/elm-wrap.rb"

          printf '%s\n' \
            'class ElmWrap < Formula' \
            '  desc "Elm package management wrapper with custom registry support"' \
            '  homepage "https://github.com/dsimunic/elm-wrap"' \
            "  version \"${VERSION}\"" \
            '  license "MIT"' \
            '' \
            '  if OS.mac?' \
            '    if Hardware::CPU.arm?' \
            "      url \"https://github.com/dsimunic/elm-wrap/releases/download/${TAG}/elm-wrap-macos-arm64\"" \
            "      sha256 \"${ARM_SHA}\"" \
            '    else' \
            "      url \"https://github.com/dsimunic/elm-wrap/releases/download/${TAG}/elm-wrap-macos-amd64\"" \
            "      sha256 \"${AMD_SHA}\"" \
            '    end' \
            '  else' \
            "    url \"https://github.com/dsimunic/elm-wrap/archive/refs/tags/${TAG}.tar.gz\"" \
            "    sha256 \"${SRC_SHA}\"" \
            '  end' \
            '' \
            '  def install' \
            '    if OS.mac?' \
            '      if Hardware::CPU.arm?' \
            '        bin.install "elm-wrap-macos-arm64" => "elm-wrap"' \
            '      else' \
            '        bin.install "elm-wrap-macos-amd64" => "elm-wrap"' \
            '      end' \
            '    else' \
            '      system "make"' \
            '      bin.install "bin/elm-wrap"' \
            '    end' \
            '  end' \
            '' \
            '  test do' \
            '    output = shell_output("#{bin}/elm-wrap --help")' \
            '    assert_match "elm-wrap", output' \
            '  end' \
            'end' > "$FORMULA"

      - name: Commit and push changes
        run: |
          VERSION="${{ steps.vars.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/elm-wrap.rb
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "elm-wrap ${VERSION}"
          git push

